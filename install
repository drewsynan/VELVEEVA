#!/bin/bash

printf "                     WELCOME TO           \n"
printf "	 _   ________ _   ___________   _____ \n"
printf "	| | / / __/ /| | / / __/ __| | / / _ |\n"
printf "	| |/ / _// /_| |/ / _// _/ | |/ / __ |\n"
printf "	|___/___/____|___/___/___/ |___/_/ |_|\n"
printf " \n"
echo "ğŸ’ƒ INSTALLING..."
echo "ğŸ” CHECKING DEPENDENCIES..."
exitstatus=0

unamestring=`uname`
platform='unknown'
pkgman='installing '

if [[ "$unamestring" == 'Darwin' ]]; then
	platform="OSX"
	pkgman="brew install"
elif [[ "$unamestring" == 'Linux' ]]; then
	platform="Linux-generic"
	linuxname=`lsb_release -si`
	if [[ "$linuxname" == 'Ubuntu' ]]; then
		platform="Ubuntu"
		pkgman="sudo apt-get install"
	else 
		pkgman="sudo yum install"
	fi
fi

command -v gcc >/dev/null 2>&1 || { 
	if [[ "$platform" == 'OSX' ]]
	then
		printf "ğŸ’© gcc not found\nğŸ‘‰ try installing the XCode command line tools\n\n"
	elif [[ "$platform" == 'Ubuntu' ]]
	then
		printf "ğŸ’© gcc not found\nğŸ‘‰ try $pgkman build-essential\n\n"
	else
		printf "ğŸ’© gcc not found\nğŸ‘‰ try $pkgman gcc\n\n" >&2
	fi

	exitstatus=1
}

command -v python3 >/dev/null 2>&1 || { printf "ğŸ’© python 3 not found\nğŸ‘‰ try $pkgman python3\n\n" >&2; exitstatus=1; }
command -v node >/dev/null 2>&1 || {
	if [[ "$platform" == 'OSX' ]]
	then
		printf "ğŸ’© nodejs not found\nğŸ‘‰ try installing the package from nodejs.org/en/download\n\n" >&2 
	elif [[ "$platform" == 'Ubuntu' ]]
	then
		printf "ğŸ’© nodejs not found\nğŸ‘‰ try $pkgman nodejs-legacy\n\n" >&2 
	else
		printf "ğŸ’© nodejs not found\nğŸ‘‰ try $pkgman node\n\n" >&2
	fi

	exitstatus=1
}

command -v npm >/dev/null 2>&1 || {
	if [[ "$platform" == 'OSX' ]]
	then
		printf "ğŸ’© npm not found\nğŸ‘‰ try installing the nodejs package from nodejs.org/en/download\n\n" >&2 
	elif [[ "$platform" == 'Ubuntu' ]]
	then
		printf "ğŸ’© npm not found\nğŸ‘‰ try $pkgman npm\n\n" >&2 
	else
		printf "ğŸ’© npm not found\nğŸ‘‰ try $pkgman npm\n\n" >&2
	fi

	exitstatus=1
}

command -v pip3 >/dev/null 2>&1 || { printf "ğŸ’© pip3 not found\nğŸ‘‰ try $pkgman python3-pip\n\n" >&2; exitstatus=1; }
command -v virtualenv >/dev/null 2>&1 || { 
	if [[ "$platform" == 'Ubuntu' ]]
	then
		printf "ğŸ’© virtualenv not found\nğŸ‘‰ try $pkgman virtualenv\n\n" >&2
	else
		printf "ğŸ’© virtualenv not found\nğŸ‘‰ try pip3 install virtualenv\n\n" >&2
	fi

	exitstatus=1
}
command -v phantomjs >/dev/null 2>&1 || { printf "ğŸ’© phantomjs not found\nğŸ‘‰ try $pkgman phantomjs\n\n" >&2; exitstatus=1; }

command -v convert >/dev/null 2>&1 || { printf "ğŸ’© ImageMagick (convert) not found\nğŸ‘‰ try $pkgman imagemagick\n\n" >&2; exitstatus=1; }
command -v mogrify >/dev/null 2>&1 || { printf "ğŸ’© ImageMagick (mogrify) not found\nğŸ‘‰ try $pkgman imagemagick\n\n" >&2; exitstatus=1; }

# check python, node versions
if [[ -z `command -v python3 >/dev/null 2>&1` ]]
then
	PYPASS=`python3 -c 'import sys; print(int(sys.version_info[0]==3 and sys.version_info[1] >= 4))'`
	if [ $PYPASS != 1 ]
	then
		{ printf "ğŸ’© unsupported python3 version found.\nğŸ‘‰ Please upgrade your python >= 3.4\n\n" >&2; exitstatus=1; }
	fi
fi

if [[ -z `command -v node >/dev/null 2>&1` ]]
then
	NODEPASS=`node --version | cut -c2- | awk -F. '{print (($1 == 0 && $2>=10) || ($1 >= 4))}'`
	if [ $NODEPASS != 1 ]
	then
		{ printf "ğŸ’© unsupported nodejs version found.\nğŸ‘‰ Please upgrade to >= 0.10\n\n" >&2; exitstatus=1; }
	fi
fi

# check for libxml2 and libxslt
if [ -z `find /usr/include -name libxml2 2>/dev/null` ]
then
	printf "ğŸ’© libxml2 not found\n" >&2
	if [[ "$platform" == 'OSX' ]]
	then
		printf "ğŸ‘‰ try $pkgman libxml2\n\n"
	elif [[ "$platform" == 'Ubuntu' ]]
	then
		printf "ğŸ‘‰ try $pkgman libxml2-dev\n\n"
	fi

	exitstatus=1
fi

if [ -z `find /usr/include -name libxslt 2>/dev/null` ]
then
	printf "ğŸ’© libxslt not found\n" >&2
	if [[ "$platform" == 'OSX' ]]
	then
		printf "ğŸ‘‰ try $pkgman libxslt\n\n"
	elif [[ "$platform" == 'Ubuntu' ]]
	then
		printf "ğŸ‘‰ try $pkgman libxslt-dev\n\n"
	fi

	exitstatus=1
fi

# check for libjpeg on linux
if [[ "$unamestring" == 'Linux' ]]
then
	if [ -z `find /usr/include -name jpeglib.h 2>/dev/null` ]
	then
		if [[ "$platform" == 'Ubuntu' ]]
		then
			printf "ğŸ’© libjpeg not found\nğŸ‘‰ try $pkgman libjpeg-dev\n\n"
		else
			printf "ğŸ’© libjpeg not found\nğŸ‘‰ try $pkgman libjpeg\n\n"
		fi

		exitstatus=1
	fi
fi

if [ $exitstatus != 0 ]
then
	echo " "
	echo "                     ğŸ’€  ğŸ’€  ğŸ’€"
	echo " "
	echo "         Some dependencies could not be met."
	echo "           Please install and try again."
	echo " "
	exit $exitstatus
else
	echo "ğŸ‰ DEPENDENCIES MET!"
fi

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

cd $DIR

echo "ğŸ INSTALLING PYTHON VIRTUALENV PACKAGES..."

virtualenv -p $(which python3) lib/velvenv
source lib/velvenv/bin/activate
pip3 install -r requirements.txt || { deactivate; echo "ğŸ˜±  Error installing python packages! Aborting. ğŸ˜±" >&2; exit 1; }
deactivate

# echo "â˜•ï¸ INSTALLING NODE MODULES..."

# npm install || { echo "ğŸ˜± Error installing node modules! Aborting. ğŸ˜±" >&2; exit 1; }

echo "ğŸ• yum!"

